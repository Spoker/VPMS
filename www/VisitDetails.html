<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="viewport" content="user-scalable=yes, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
        <title>Visit Details</title>
        <link rel="stylesheet" type="text/css" href="css/jquery-ui.css">
        <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/index.css">
        <link rel="stylesheet" type="text/css" href="css/loading.css">
        <script type="text/javascript" src="js/jquery-1.10.2.js"></script>
        <script type="text/javascript" src="js/jquery-ui.js"></script>
        <style type="text/css">
            .input-group-btn select
            {
                border-color: #ccc;
                margin-top: 0px;
                margin-bottom: 0px;
                padding-top: 7px;
                padding-bottom: 7px;
            }
            .ui-datepicker{
                font-size: 12px;
            }
            .ui-widget-header .ui-icon { 
                 background-image: url(images/ui-icons_228ef1_256x240.png);
             }
            #txtDate{
                background-color: transparent;
            }
        </style>
    </head>
    <body onload="onLoad()">
        <img class="headerbar" src="img/headerbar.png" width="100%" height="5px"><br>
        <div id="loading" class="loading">Loading&#8230;</div>
        <!--<div id="divloading" class="divWaiting" style="display: none">
            <span id="imgloading">
                <img src="img/loading.gif" alt="Loading" width="90" height="75"><br>
                <label class="text text-success">Loading Please Wait...</label>
            </span>
        </div>-->
        <div id="container" class="container text-center">
            <img class="logo" src="img/headerlogobar.png" height="40" width="350">
            <div class="modal-dialog text-left">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="myModalLabel">Visit Details</h3>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-1"></div>
                            <div class="col-md-10">
                                <div style="padding: 8px"><!-- class="well" -->
                                    <small>
                                        <form id="form1" class="form-horizontal">
                                            <div class="form-group text-left">
                                                <div class="form-group">
                                                    <label for="txtCompany" class="control-label col-md-3">Company</label>
                                                    <div class="col-md-8"><input type="text" class="form-control text-capitalize" id="txtCompany" name="txtCompany" value="" required title="Please enter Company"></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="txtDate" class="control-label col-md-3">Visit Date</label>
                                                    <div class="col-md-8"><input type="text" class="form-control" id="txtDate" name="txtDate" value="" required title="Please enter Visit Date" readonly></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="selDept" class="control-label col-md-3">Department</label>
                                                    <div class="col-md-8"><select id="selDept" class="form-control">
                                                        <option value="0" selected>Select</option>
                                                    </select></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="txtPersons" class="control-label col-md-3">Accompained Persons</label>
                                                    <div class="col-md-8"><input type="number" class="form-control" id="txtPersons" name="txtPersons" value="" required title="Please enter the No of Persons visiting" min="1" max="10" maxlength="3"></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="txtPurpose" class="control-label col-md-3">Visit Purpose</label>
                                                    <div class="col-md-8"><textarea class="form-control text-capitalize" id="txtPurpose" name="txtPurpose" title="Please Enter the Visit Purpose" required rows="3"></textarea></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="selVehType" class="control-label col-md-3">Vehicle Type</label>
                                                    <div class="col-md-8"><select id="selVehType" class="form-control">
                                                        <option value="0" selected>Select</option>
                                                    </select></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="txtVehNumber" class="control-label col-md-3">Vehicle No</label>
                                                    <div class="col-md-8"><input type="text" class="form-control text-uppercase" id="txtVehNumber" name="txtVehNumber" value="" disabled required title="Please enter Vehicle Number"></div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="drivetype" class="control-label col-md-3">Self Driving</label>&nbsp;
                                                    <div class="col-md-8"><div class="radio-inline">
                                                      <label><input type="radio" name="drivetype" value="N" checked>No</label>
                                                    </div>
                                                    <div class="radio-inline">
                                                      <label><input type="radio" name="drivetype" value="Y">Yes</label>
                                                        </div></div>
                                                </div>
                                                <code class="text-center">* All Fields are mandatory.</code><br><br>
                                                <button type="button" class="btn btn-success btn-block" id="btnSubmit">Submit</button>
                                            </div>
                                        </form>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div><br><br>
        <input type="hidden" id="hidRequestId">
        <input type="hidden" id="hidEmail">
        <footer>
            <div class="container text-center">
                <small><span class="text-primary">Â© <script>document.write(new Date().getFullYear())</script> - KRISHNAPATNAM PORT COMPANY LTD.</span></small>
            </div>
        </footer>
    </body>
</html>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript">
    var apiURL = 'http://61.0.225.169/vpmsapi/api/VisitDetails/AddVisitDetails';
    var deptURL = 'http://61.0.225.169/vpmsapi/api/Master/GetDepartments';
    var vechTypeURL = 'http://61.0.225.169/vpmsapi/api/Master/GetVehicleType';
    var qsParm = new Array();
    var Email = null;
    var _vehType = null;
    function qs() {
        var query = window.location.search.substring(1);
        var parms = query.split('&');
        for (var i=0; i < parms.length; i++) {
            var pos = parms[i].indexOf('=');
            if (pos > 0) {
                var key = parms[i].substring(0, pos);
                var val = parms[i].substring(pos + 1);
                qsParm[key] = val;
            }
        }
        if(parms.length > 1){
            $("#hidRequestId").val(qsParm["reqid"]);
            $("#hidEmail").val(qsParm["mail"]);
            return true;
        }
        else{
            window.location.href = 'VisitorRequest.html';
            return false;
        }
    }
        
    function onLoad() {
        document.addEventListener("deviceready", onDeviceReady, false);
    }

    /* device APIs are available */
    function onDeviceReady() {
        /* Register the event listener */
        document.addEventListener("backbutton", onBackKeyDown, false);
    }

    /* Handle the back button */
    function onBackKeyDown() {
    }
        
    function checkConnection() {
        var networkState = navigator.connection.type;
        var states = {};
        states[Connection.UNKNOWN]  = 'Unknown connection';
        states[Connection.ETHERNET] = 'Ethernet connection';
        states[Connection.WIFI]     = 'WiFi connection';
        states[Connection.CELL_2G]  = 'Cell 2G connection';
        states[Connection.CELL_3G]  = 'Cell 3G connection';
        states[Connection.CELL_4G]  = 'Cell 4G connection';
        states[Connection.CELL]     = 'Cell generic connection';
        states[Connection.NONE]     = 'No network connection';

<<<<<<< HEAD
            $("#txtDate").datepicker({
                /*numberOfMonths: 2,*/
                minDate: 1, 
                maxDate: "+1M +10D"
=======
        //alert('Connection type: ' + states[networkState]);
        if(states[networkState] == 'No network connection' || states[networkState] == 'Unknown connection')
            alert('No Internet Connection. Please Check.');
    }
    var myvar = setInterval(checkConnection, 3000);
        
    $(document).ready(function () {
        var Status = qs();
        $("#loading").hide();
        /*if(Status){
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: deptURL,
                dataType: "json",
                success: function (result) {
                    $.each(result, function (key, value) {
                        $("#selDept").append($("<option></option>").val(value.Id).html(value.Name));
                    });
                },
                error: function (result) {
                    alert(result.message);
                }
>>>>>>> origin/master
            });
        }*/
            
        $("#txtDate").keypress(function () {
            return false;
        });

        $("#txtDate").datepicker({
            /*numberOfMonths: 2,*/
            minDate: 1, maxDate: "+1M +10D"
        });
            
        if(Status){
            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: vechTypeURL,
                dataType: "json",
                success: function (result) {
                    $.each(result, function (key, value) {
                        $("#selVehType").append($("<option></option>").val(value.Id).html(value.Name));
                    });
                },
                error: function (result) {
                    alert(result.message);
                }
            });
        }
            
        $("#selVehType").change(function(){
            var str = "";
            $("#selVehType option:selected").each(function() {
                str += $(this).text().trim();
            });
            if(str == "Select"){
                _vehType = "";
                $("#txtVehNumber").attr('disabled', 'disabled');
            }
            else{
                _vehType = $("#selVehType option:selected").val()
                $("#txtVehNumber").attr('disabled', false);
                $("#txtVehNumber").focus();
            }
        });

        $("#btnSubmit").click(function () {
            var _dept = $("#selDept option:selected").val();
            var _drivetype = $("input[name='drivetype']:checked").val();
            if(FormValidations()){
                if(!ValidateText($("#txtCompany").val())){
                    alert('Numbers not allowed. Please enter valid Company Name');
                    $("#txtCompany").focus();
                    /* e.preventDefault(); */
                    return false;
                }
                else if(!ValidateText($("#txtCompany").val())){
                    alert('Numbers not allowed. Please enter valid Company Name');
                    $("#txtCompany").focus();
                    /* e.preventDefault(); */
                    return false;
                }
                else{
                    $("#loading").show();
                    var Adddata = {};
                    Adddata.Company = $("#txtCompany").val();
                    Adddata.VisitDate = $("#txtDate").val();
                    Adddata.Department = _dept;
                    Adddata.NoofPersons = $("#txtPersons").val();
                    Adddata.VisitPurpose = $("#txtPurpose").val();
                    Adddata.VehicleNumber = $("#txtVehNumber").val();
                    Adddata.VehicleType = _vehType;
                    Adddata.SelfDriving = _drivetype;
                    Adddata.RequestId = $("#hidRequestId").val();
                    Adddata.Email = $("#hidEmail").val();
                    $.ajax({
                        url: apiURL,
                        type: 'POST',
                        data: Adddata,
                        dataType: 'json',
                        success: function (data) {
                            window.location.href = 'RequestEnd.html?reqid=' + $("#hidRequestId").val() + '&mail=' + $("#hidEmail").val();
                        },
                        statusCode: {
                            404: function () {
                                alert('Failed');
                                $("#loading").hide();
                            }
                        }
                    });
                }
            }
            else{
                $("#loading").hide();
                $("#container").show()
            }
        });
    });
        
    function FormValidations()
    {
        var _dept = $("#selDept option:selected").val();
        var _drivetype = $("input[name='drivetype']:checked").val();
        if($("#txtCompany").val()==""){
            alert('Please Enter Company');
            $("#txtCompany").focus();
            return false;
        }
        else if($("#txtDate").val()==""){
            alert('Please Select Visit Date');
            $("#txtDate").focus();
            return false;
        }
        else if(parseInt(_dept)==0){
            alert('Plese Select Department.');
            $("#selDept").focus();
            return false;
        }
        else if($("#txtPersons").val()!=""){
            if(parseInt($("#txtPersons").val())<1 || parseInt($("#txtPersons").val())>10){
                alert('Please Enter No.of Persons in between 1 and 10.');
                $("#txtPersons").focus();
                return false;
            }
        }
            
        if($("#txtPurpose").val()==""){
            alert('Please Enter Visit Purpose.');
            $("#txtPurpose").focus();
            return false;
        }
        else if(parseInt(_vehType)>0){
            if($("#txtVehNumber").val()==""){
                alert('Please Enter Vehicle Number.');
                $("#txtVehNumber").focus();
                return false;
            }
        }
        return true;
    }
</script>
