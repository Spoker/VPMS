<!DOCTYPE html>
<html>
    <head>
        <title>Photo Capture and Upload</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/index.css">
    </head>
    <body onload="onLoad()">
        <img class="headerbar" src="img/headerbar.png" width="100%" height="5px"><br>
        <div id="divloading" class="divWaiting" style="display: none">
            <span id="imgloading">
                <img src="img/loading.gif" alt="Loading" width="90" height="75"><br>
                <label class="text text-success">Loading Please Wait...</label>
            </span>
        </div>
        <div id="container" class="container text-center">
            <img class="logo" src="img/headerlogobar.png" height="40" width="350">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="myModalLabel">Visit Details</h3>
                    </div>
                    <div class="modal-body">
                        <div class="text-left">
                            <b>Status:</b> <span id="camera_status"></span><br>
                            <b>Image:</b> <img style="width:150px;visibility:hidden;display:none;" id="camera_image" src="" />
                        </div>
                        <!-- Actions -->
                        <div class="text-center">
                            <input type="button" id="btnCapture" class="btn btn-primary btn-block btn-md" onclick="takePicture();" value="Take Picture" /><br/>
                            <input type="button" id="btnSelect" class="btn btn-primary btn-block btn-md" onclick="selectPicture();" value="Select Picture from Library" /><br/>
                            <input type="button" id="btnUpload" class="btn btn-success btn-block btn-md" onclick="uploadPicture();" value="Upload Picture" />
                        </div>
                        <br/>
                        <img style="display:none;width: 100%;height:200px;" id="smallImage" src="" />
                        <img style="display:none;" id="largeImage" src="" />
                        <input type="hidden" id="hidRequestId">
                        <input type="hidden" id="hidEmail">
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="container text-center">
                <small><span class="text-primary">Â© <script>document.write(new Date().getFullYear())</script> - KRISHNAPATNAM PORT COMPANY LTD.</span></small>
            </div>
        </footer>
    </body>
    <script type="text/javascript" charset="utf-8" src="bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery.min.js"></script>    
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/phonegap-1.1.0.js"></script>
    <script type="text/javascript" charset="utf-8">
        var deviceReady = false;
        var qsParm = new Array();
        
        function onLoad() {
            document.addEventListener("deviceready", onDeviceReady, false);
        }

        /* device APIs are available */
        function onDeviceReady() {
            /* Register the event listener */
            document.addEventListener("backbutton", onBackKeyDown, false);
        }

        /* Handle the back button */
        function onBackKeyDown() {
        }
        
        function qs() {
            var query = window.location.search.substring(1);
            var parms = query.split('&');
            for (var i=0; i < parms.length; i++) {
                var pos = parms[i].indexOf('=');
                if (pos > 0) {
                    var key = parms[i].substring(0, pos);
                    var val = parms[i].substring(pos + 1);
                    qsParm[key] = val;
                }
            }
            if(parms.length > 1){
                $("#hidRequestId").val(qsParm["reqid"]);
                $("#hidEmail").val(qsParm["mail"]);
            }
            else{
                window.location.href = 'VisitorRequest.html';
            }
        }
        
        $(document).ready(function(){
            qs();
        });
        
        function takePicture() {
            navigator.camera.getPicture(
                function(uri) {
                    var img = document.getElementById('camera_image');
                    img.style.visibility = "visible";
                    img.style.display = "block";
                    img.src = uri;
                    document.getElementById('camera_status').innerHTML = "Success";
                },
                function(e) {
                    console.log("Error getting picture: " + e);
                    document.getElementById('camera_status').innerHTML = "Error getting picture.";
                },
                { quality: 50, destinationType: navigator.camera.DestinationType.FILE_URI, correctOrientation: true}
            );
        };

        function selectPicture() {
            navigator.camera.getPicture(
                function(uri) {
                    var img = document.getElementById('camera_image');
                    img.style.visibility = "visible";
                    img.style.display = "block";
                    img.src = uri;
                    document.getElementById('camera_status').innerHTML = "Success";
                },
                function(e) {
                    console.log("Error getting picture: " + e);
                    document.getElementById('camera_status').innerHTML = "Error getting picture.";
                },
                { quality: 50, destinationType: navigator.camera.DestinationType.FILE_URI, 
                sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY}
            );
        };
        
        function uploadPicture() {
            $("#divloading").show();
            $("#container").hide();
            var img = document.getElementById('camera_image');
            var imageURI = img.src;
            if (!imageURI || (img.style.display == "none")) {
                document.getElementById('camera_status').innerHTML = "Take picture or select picture from library first.";
                return;
            }
            /*$("#btnCapture").css('class', 'btn btn-info btn-block btn-md disabled');
            $("#btnSelect").css('class', 'btn btn-info btn-block btn-md disabled');
            $("#btnUpload").css('class', 'btn btn-info btn-block btn-md disabled');
            var server = 'http://61.0.225.169:81/ContainerSearch/upload.php';*/
            var server = 'http://61.0.225.169/VPMSAPI/api/FileUpload/UploadFile';
            if (server) {
                var options = new FileUploadOptions();
                options.fileKey = "file";
                /*options.fileName = imageURI.substr(imageURI.lastIndexOf('/')+1);*/
                options.fileName = $("#hidRequestId").val();
                options.mimeType = "image/jpeg";
                options.chunkedMode = false;
                options.headers = {
                    Connection: "close"
                }
                server = server + '/' + options.fileName;
                document.getElementById('camera_status').innerHTML = options.fileName;
                
                var ft = new FileTransfer();
                ft.upload(imageURI, encodeURI(server), function(r) {
                    $("#divloading").hide();
                    $("#container").show();
                    document.getElementById('camera_status').innerHTML = "Upload successful: " + (parseFloat(parseFloat(r.bytesSent)/1024)/1024) + " MB uploaded.";
                    window.location.href = 'VisitDetails.html?reqid=' + $("#hidRequestId").val() + '&mail=' + $("#hidEmail").val();;
                }, function(error) {
                    $("#divloading").hide();
                    $("#container").show();
                    document.getElementById('camera_status').innerHTML = "Upload failed: Code = " + error.code;
                }, options);
            }
        }
        
        function init() {
            document.addEventListener("deviceready", function() {deviceReady = true;}, false);
            window.setTimeout(function() {
                if (!deviceReady) {
                    alert("Error: Camera not initialised.");
                }
            },2000);
        }
    </script>
</html>