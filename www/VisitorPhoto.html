<!DOCTYPE html>
<html>
    <head>
        <title>Capture Photo</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
    </head>
    <body>
        <div class="container">
            <div class="page-header">
                <h3>Capture and Upload</h3>
            </div>
            <div class="well" style="padding: 10px 50px;">
                <!--<div class="btn-group-vertical btn-group-md">
                    <button class="btn btn-info btn-block" onclick="capturePhoto();">Take Picture
                        <span class="glyphicon glyphicon-camera"></span>
                    </button>
                    <button class="btn btn-info btn-block" onclick="getPhoto(pictureSource.PHOTOLIBRARY);">Select From Photo Library
                        <span class="glyphicon glyphicon-camera"></span>
                    </button>
                    <input id="fileUpload" type="file">
                    <button id="btnUpload" class="btn btn-info btn-block">Upload</button>
                </div>-->
                <!-- Camera -->
                <div>
                    <h3>Camera:</h3>
                    <b>Status:</b> <span id="camera_status"></span><br>
                    <b>Image:</b> <img style="width:120px;visibility:hidden;display:none;" id="camera_image" src="" />
                </div>
                    
                <!-- Actions -->
                <div>
                    <input type="button" id="btnCapture" class="btn btn-info btn-block btn-md" onclick="takePicture();" value="Take Picture" /><br/>
                    <input type="button" id="btnSelect" class="btn btn-info btn-block btn-md" onclick="selectPicture();" value="Select Picture from Library" /><br/>
                    <input type="button" id="btnUpload" class="btn btn-info btn-block btn-md" onclick="uploadPicture();" value="Upload Picture" />
                </div>
                <br/>
            </div>
            <img style="display:none;width: 100%;height:200px;" id="smallImage" src="" />
            <img style="display:none;" id="largeImage" src="" />
            <input type="hidden" id="hidEmail">
        </div>
    </body>
    <script type="text/javascript" charset="utf-8" src="bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/jquery.min.js"></script>    
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/phonegap-1.1.0.js"></script>
    <script type="text/javascript" charset="utf-8">
        var deviceReady = false;
        
        function qs() {
            var query = window.location.search.substring(1);
            var parms = query.split('&');
            for (var i=0; i < parms.length; i++) {
                var pos = parms[i].indexOf('=');
                if (pos > 0) {
                    var key = parms[i].substring(0, pos);
                    var val = parms[i].substring(pos + 1);
                    qsParm[key] = val;
                }
            }
            $("#hidEmail").val(qsParm["mail"]);
        }
        
        function takePicture() {
            navigator.camera.getPicture(
                function(uri) {
                    var img = document.getElementById('camera_image');
                    img.style.visibility = "visible";
                    img.style.display = "block";
                    img.src = uri;
                    document.getElementById('camera_status').innerHTML = "Success";
                },
                function(e) {
                    console.log("Error getting picture: " + e);
                    document.getElementById('camera_status').innerHTML = "Error getting picture.";
                },
                { quality: 50, destinationType: navigator.camera.DestinationType.FILE_URI}
            );
        };

        function selectPicture() {
            navigator.camera.getPicture(
                function(uri) {
                    var img = document.getElementById('camera_image');
                    img.style.visibility = "visible";
                    img.style.display = "block";
                    img.src = uri;
                    document.getElementById('camera_status').innerHTML = "Success";
                },
                function(e) {
                    console.log("Error getting picture: " + e);
                    document.getElementById('camera_status').innerHTML = "Error getting picture.";
                },
                { quality: 50, destinationType: navigator.camera.DestinationType.FILE_URI, 
                sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY}
            );
        };
        
        function uploadPicture() {
            var img = document.getElementById('camera_image');
            var imageURI = img.src;
            if (!imageURI || (img.style.display == "none")) {
                document.getElementById('camera_status').innerHTML = "Take picture or select picture from library first.";
                return;
            }
            $("#btnCapture").css('class', 'btn btn-info btn-block btn-md disabled');
            $("#btnSelect").css('class', 'btn btn-info btn-block btn-md disabled');
            $("#btnUpload").css('class', 'btn btn-info btn-block btn-md disabled');
            //var server = 'http://61.0.225.169:81/ContainerSearch/upload.php';
            var server = 'http://61.0.225.169/VPMSAPI/api/FileUpload/UploadFile';
            if (server) {
                var options = new FileUploadOptions();
                options.fileKey = "file";
                //options.fileName = imageURI.substr(imageURI.lastIndexOf('/')+1);
                options.fileName = "Visitor1";
                options.mimeType = "image/jpeg";
                options.chunkedMode = false;
                options.headers = {
                    Connection: "close"
                }
                
                document.getElementById('camera_status').innerHTML = options.fileName;
                
                var ft = new FileTransfer();
                ft.upload(imageURI, encodeURI(server), function(r) {
                    alert("Success");
                    document.getElementById('camera_status').innerHTML = "Upload successful: " + (parseFloat(parseFloat(r.bytesSent)/1024)/1024) + " MB uploaded.";
                    //window.location.href = 'VisitDetails.html?mail=' + $("#hidEmail").val();
                }, function(error) {
                    //alert("Filed");
                    document.getElementById('camera_status').innerHTML = "Upload failed: Code = " + error.code;
                }, options);
            }
        }
        
        function init() {
            document.addEventListener("deviceready", function() {deviceReady = true;}, false);
            window.setTimeout(function() {
                if (!deviceReady) {
                    alert("Error: PhoneGap did not initialize.  Demo will not run correctly.");
                }
            },2000);
        }
    </script>
</html>